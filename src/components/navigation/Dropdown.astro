---
import { languages, type LangCode } from '@/i18n/config';
import { routes, type RouteKey } from '@/i18n/routes';

interface Props {
  label?: string;
  type: 'language' | 'category';
  items?: { key: string; label: string }[];
  lang: LangCode;
  isMobile?: boolean;
}

const { label, type, items, lang, isMobile } = Astro.props;

/**
 * Funzione helper per ottenere il path sicuro evitando errori di indicizzazione TS.
 * Castiamo 'routes' per permettere l'accesso dinamico tramite LangCode e RouteKey.
 */
function getCategoryPath(categoryKey: string) {
  const langRoutes = (routes as Record<LangCode, Record<string, string>>)[lang];
  const categorySlug = langRoutes[categoryKey];
  const prefix = lang === 'en' ? '' : `/${lang}`;
  return `${prefix}/blog/${categorySlug}`.replace(/\/+/g, '/');
}
---

<div class={`dropdown-container ${isMobile ? 'upward' : ''}`}>
  <button class="dropdown-trigger" aria-haspopup="true">
    {type === 'language' ? lang.toUpperCase() : label}
    <svg class="chevron" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4">
      <path d="m6 9 6 6 6-6"/>
    </svg>
  </button>

  <div class="dropdown-menu">
    {type === 'language' ? (
      Object.keys(languages).map((l) => (
        <a 
          href={l === 'en' ? '/' : `/${l}`} 
          class={lang === l ? 'active' : ''}
        >
          {l.toUpperCase()}
        </a>
      ))
    ) : (
      items?.map((item) => (
        <a href={getCategoryPath(item.key)}>
          {item.label}
        </a>
      ))
    )}
  </div>
</div>

<style>
  .dropdown-container { position: relative; display: inline-block; }
  
  .dropdown-trigger {
    background: none; border: none; color: inherit; font-weight: 800;
    text-transform: uppercase; letter-spacing: 0.15em; cursor: pointer;
    display: flex; align-items: center; gap: 8px; font-size: 0.85rem;
    padding: 0.5rem 0;
  }

  .chevron { transition: transform 0.3s; opacity: 0.6; }
  .dropdown-container:hover .chevron { transform: rotate(180deg); color: var(--gold); }

  .dropdown-menu {
    position: absolute; background: var(--bg-monolith);
    border: 1px solid var(--gold); min-width: 200px;
    opacity: 0; visibility: hidden; 
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 1000; padding: 0.5rem 0;
    box-shadow: 0 15px 30px rgba(0,0,0,0.5);
  }

  /* Logica Desktop (Scende) vs Mobile (Sale) */
  .dropdown-container:not(.upward) .dropdown-menu { 
    top: 100%; 
    right: 0; 
    transform: translateY(10px);
  }
  
  .dropdown-container.upward .dropdown-menu { 
    bottom: 110%; 
    left: 50%; 
    transform: translate(-50%, -10px); 
  }

  .dropdown-container:hover .dropdown-menu { 
    opacity: 1; 
    visibility: visible; 
  }
  
  .dropdown-container:not(.upward):hover .dropdown-menu { transform: translateY(0); }
  .dropdown-container.upward:hover .dropdown-menu { transform: translate(-50%, 0); }

  .dropdown-menu a {
    display: block; padding: 0.8rem 1.5rem; color: var(--text-main);
    font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
    text-decoration: none; transition: 0.2s;
    letter-spacing: 0.1em;
  }

  .dropdown-menu a:hover, .dropdown-menu a.active { 
    background: var(--gold); 
    color: var(--bg-monolith); 
  }

  /* Linea di accento per categorie */
  .dropdown-menu a:not(.active):hover {
    padding-left: 1.8rem;
  }
</style>