---
import { useTranslations } from '@/i18n/ui';
import type { LangCode } from '@/i18n/config';

interface Props { lang: LangCode; }
const { lang } = Astro.props;
const t = useTranslations(lang);
---

<div class="search-module">
  <button id="search-trigger" class="icon-btn" aria-label={t('nav.search')}>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
  </button>

  <div id="search-overlay" class="search-overlay">
    <div class="search-modal">
      <div class="modal-header">
        <span class="modal-label">{t('nav.search')}</span>
        <button id="search-close" class="close-btn">&times;</button>
      </div>
      
      <div class="search-input-wrapper">
        <input 
          type="search" 
          id="search-input"
          placeholder={t('search.placeholder')} 
          autocomplete="off"
          data-lang={lang}
        />
        <div id="search-loader" class="loader"></div>
      </div>

      <div id="search-results" class="results-container"></div>
    </div>
  </div>
</div>

<style>
  .search-overlay {
    position: fixed; inset: 0; background: var(--bg-modal); z-index: 5000;
    display: flex; justify-content: center; padding-top: 10vh;
    opacity: 0; visibility: hidden; transition: var(--transition);
  }
  .search-overlay.is-active { opacity: 1; visibility: visible; }
  .search-modal { width: 100%; max-width: 900px; padding: 0 2rem; }
  
  input {
    width: 100%; border-bottom: 2px solid var(--gold); font-size: 3rem;
    font-weight: 200; text-transform: uppercase; padding: 1rem 0;
  }

  .results-container { margin-top: 2rem; max-height: 60vh; overflow-y: auto; }
  
  /* Stile Risultato Live */
  :global(.search-result-item) {
    display: flex; justify-content: space-between; align-items: center;
    padding: 1.5rem; border-bottom: 1px solid var(--gold-muted);
    transition: 0.3s;
  }
  :global(.search-result-item:hover) { background: var(--gold-muted); }
  :global(.result-title) { font-weight: 800; text-transform: uppercase; color: var(--gold); }
  :global(.result-cat) { font-size: 0.7rem; letter-spacing: 0.2em; opacity: 0.6; }

  .loader { height: 2px; width: 0; background: var(--gold); transition: 0.3s; }
  .loader.loading { width: 100%; }
</style>

<script>
  import { actions } from 'astro:actions';

  function initLiveSearch() {
    const input = document.getElementById('search-input') as HTMLInputElement;
    const resultsContainer = document.getElementById('search-results');
    const loader = document.getElementById('search-loader');
    const triggers = document.querySelectorAll('#search-trigger, #mobile-search-trigger');
    const overlay = document.getElementById('search-overlay');
    const close = document.getElementById('search-close');

    // Toggle Overlay
    triggers.forEach(t => t.addEventListener('click', () => {
        overlay?.classList.add('is-active');
        setTimeout(() => input?.focus(), 200);
    }));
    close?.addEventListener('click', () => overlay?.classList.remove('is-active'));

    input?.addEventListener('input', async (e) => {
      const query = (e.target as HTMLInputElement).value;
      const lang = input.dataset.lang as any;

      if (query.length < 2) {
        if (resultsContainer) resultsContainer.innerHTML = '';
        return;
      }

      loader?.classList.add('loading');
      
      const { data, error } = await actions.search({ query, lang });
      
      loader?.classList.remove('loading');

      if (data && resultsContainer) {
        resultsContainer.innerHTML = data.length > 0 
          ? data.map(res => `
              <a href="${res.url}" class="search-result-item">
                <span class="result-title">${res.title}</span>
                <span class="result-cat">${res.categoryLabel}</span>
              </a>
            `).join('')
          : `<p style="text-align:center; padding: 2rem; opacity: 0.5;">NESSUN RISULTATO</p>`;
      }
    });
  }

  initLiveSearch();
  document.addEventListener('astro:after-swap', initLiveSearch);
</script>