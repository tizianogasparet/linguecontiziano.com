---
// src/pages/[...lang]/[slug].astro
import MainLayout from '@/components/layout/MainLayout.astro';
import { getCollection } from 'astro:content';
import { render } from 'astro:content';
import { supportedLanguages, defaultLang, type LangCode } from '@/i18n/config';
import { routes, type RouteKey } from '@/i18n/routes';

export async function getStaticPaths() {
  const paths = [];
  const [pages, legals] = await Promise.all([
    getCollection('pages'),
    getCollection('legal')
  ]);

  const allEntries = [...pages, ...legals];

  for (const lang of supportedLanguages) {
    for (const [routeKey, slug] of Object.entries(routes[lang])) {
      if (routeKey === 'home') continue;

      const exists = allEntries.some(
        entry => entry.data.lang === lang && entry.data.translationId === routeKey
      );

      if (exists) {
        paths.push({
          params: {
            lang: lang === defaultLang ? undefined : lang,
            slug: slug
          },
          props: { lang, routeKey }
        });
      }
    }
  }

  return paths;
}

interface Props {
  lang: LangCode;
  routeKey: RouteKey;
}

const { lang, routeKey } = Astro.props as Props;

const [pageMatch, legalMatch] = await Promise.all([
  getCollection('pages', ({ data }) => 
    data.lang === lang && data.translationId === routeKey
  ),
  getCollection('legal', ({ data }) => 
    data.lang === lang && data.translationId === routeKey
  )
]);

const entry = pageMatch[0] || legalMatch[0];
if (!entry) {
  return Astro.redirect(`/${lang}/404`);
}

const { Content } = await render(entry);
const { title } = entry.data;
const isLegal = !!legalMatch[0];
---

<MainLayout lang={lang}>
  <div class="monolith-container">
    <article class="static-page">
      <h1 class="monolith-title">{title}</h1>
      <div class="page-content">
        <Content />
      </div>
    </article>
  </div>
</MainLayout>

<style>
/* Stesso stile di index.astro */
.static-page {
  padding: 6rem 0;
}

.page-content {
  font-size: 1.2rem;
  line-height: 1.8;
  color: var(--text-main);
}

.page-content :global(h2) {
  font-size: 2.2rem;
  color: var(--gold);
  margin: 3rem 0 1.5rem;
  text-transform: uppercase;
  font-weight: 900;
}

.page-content :global(p) {
  margin-bottom: 1.5rem;
}
</style>