---
import { getCollection, render } from 'astro:content';
import MainLayout from '@/components/layout/MainLayout.astro';
import PostScene from '@/components/blog/PostScene.astro';
import { routes, type RouteKey } from '@/i18n/routes';
import { defaultLang, type LangCode } from '@/i18n/config';

export async function getStaticPaths() {
  const pages = await getCollection('pages');
  const legal = await getCollection('legal');
  
  const allEntries = [
    ...pages.map(e => ({ ...e, collectionName: 'pages' })),
    ...legal.map(e => ({ ...e, collectionName: 'legal' }))
  ];

  return allEntries
    .filter(entry => entry.data.translationId !== 'home') // Escludiamo la home gestita sopra
    .map((entry) => {
      const lang = entry.data.lang as LangCode;
      const routeKey = entry.data.translationId as RouteKey;
      
      // Recupera lo slug tradotto dal file routes.ts
      const slug = routes[lang]?.[routeKey];

      if (!slug) {
        console.warn(`Missing route for key "${routeKey}" in language "${lang}"`);
        return null;
      }

      return {
        params: { 
          lang: lang === defaultLang ? undefined : lang,
          slug: slug 
        },
        props: { 
          entry, 
          lang, 
          isLegal: entry.collectionName === 'legal' 
        },
      };
    })
    .filter(Boolean);
}

interface Props {
  entry: any;
  lang: LangCode;
  isLegal: boolean;
}

const { entry, lang, isLegal } = Astro.props;
const { Content } = await render(entry);

// Gestione sicura della descrizione (fallback al titolo se manca)
const description = entry.data.description || entry.data.title;
---

<MainLayout 
  lang={lang} 
  title={entry.data.title} 
  description={description}
  isLegal={isLegal}
>
  <PostScene title={entry.data.title}>
    <Content />
  </PostScene>
</MainLayout>