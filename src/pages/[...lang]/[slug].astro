---
import MainLayout from '@/components/layout/MainLayout.astro';
import PostScene from '@/components/blog/PostScene.astro';
import { getCollection } from 'astro:content';
import { render } from 'astro:content';
import { supportedLanguages, defaultLang, type LangCode } from '@/i18n/config';
import { routes, type RouteKey } from '@/i18n/routes';

// âœ… Genera TUTTE le pagine statiche + legali per TUTTE le lingue
export async function getStaticPaths() {
  const paths = [];

  // Carica tutte le entry una volta
  const [pages, legals] = await Promise.all([
    getCollection('pages'),
    getCollection('legal')
  ]);

  const allEntries = [...pages, ...legals];

  for (const lang of supportedLanguages) {
    for (const [routeKey, slug] of Object.entries(routes[lang])) {
      // Salta la home (gestita da index.astro)
      if (routeKey === 'home') continue;

      // Verifica che esista un contenuto con quel translationId e lingua
      const exists = allEntries.some(
        entry => entry.data.lang === lang && entry.data.translationId === routeKey
      );

      if (exists) {
        paths.push({
          params: {
            lang: lang === defaultLang ? undefined : lang,
            slug: slug
          },
          props: { lang, routeKey, slug }
        });
      }
    }
  }

  return paths;
}

interface Props {
  lang: LangCode;
  routeKey: RouteKey;
  slug: string;
}

const { lang, routeKey } = Astro.props as Props;

// Recupera l'entry esatta
const [pageMatch, legalMatch] = await Promise.all([
  getCollection('pages', ({ data }) => 
    data.lang === lang && data.translationId === routeKey
  ),
  getCollection('legal', ({ data }) => 
    data.lang === lang && data.translationId === routeKey
  )
]);

const entry = pageMatch[0] || legalMatch[0];
const isLegal = !!legalMatch[0];

if (!entry) {
  return Astro.redirect(`/${lang}/404`);
}

const { Content } = await render(entry);
const { title, description } = entry.data;
const finalDescription = description || title;
---

<MainLayout lang={lang} title={title} description={finalDescription} isLegal={isLegal}>
  <PostScene title={title}>
    <Content />
  </PostScene>
</MainLayout>