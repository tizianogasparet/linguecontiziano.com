---
// src/pages/[...lang]/blog/[...page].astro
import { getCollection } from 'astro:content';
import MainLayout from '@/components/layout/MainLayout.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import { useTranslations } from '@/i18n/ui';
import { routes } from '@/i18n/routes';
import { supportedLanguages, defaultLang, type LangCode } from '@/i18n/config';
import type { CollectionEntry } from 'astro:content';

function getPostHref(post: CollectionEntry<'blog'>, lang: LangCode): string {
  const postSlug = post.id.split('/').pop()?.replace(/\.(mdx|md)$/, '') || '';
  const catKey = post.data.category;
  const catSlug = routes[lang][catKey];
  const prefix = lang === defaultLang ? '' : `/${lang}`;
  return `${prefix}/blog/${catSlug}/${postSlug}`.replace(/\/+/g, '/');
}

export async function getStaticPaths({ paginate }: any) {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);

  return supportedLanguages.flatMap(lang => {
    const langPosts = allPosts.filter(p => p.data.lang === lang);
    if (langPosts.length === 0) return [];

    return paginate(langPosts, {
      params: { lang: lang === defaultLang ? undefined : lang },
      pageSize: 12,
      props: { lang }
    });
  });
}

interface Props {
  page: any;
  lang: LangCode;
}

const { page, lang } = Astro.props as Props;
const t = useTranslations(lang);
---

<MainLayout lang={lang}>
  <div class="monolith-container">
    <header class="blog-header animate-fade">
      <span class="section-label">{t('nav.logo')}</span>
      <h1 class="monolith-title">{t('nav.blog')}</h1>
    </header>

    <section class="blog-grid">
      {page.data.map((post: CollectionEntry<'blog'>) => (
        <BlogCard 
          title={post.data.title}
          date={post.data.pubDate}
          href={getPostHref(post, lang)}
          author="Tiziano Gasparet"
          categoryLabel={t(post.data.category)}
          lang={lang}
        />
      ))}
    </section>

    {page.lastPage > 1 && (
      <nav class="pagination" aria-label="Pagination">
        {page.url.prev ? (
          <a href={page.url.prev} class="nav-link">← PREV</a>
        ) : <span class="disabled">←</span>}
        
        <div class="page-counter">
          <span class="current">{page.currentPage}</span>
          <span class="sep">/</span>
          <span class="total">{page.lastPage}</span>
        </div>

        {page.url.next ? (
          <a href={page.url.next} class="nav-link">NEXT →</a>
        ) : <span class="disabled">→</span>}
      </nav>
    )}
  </div>
</MainLayout>

<style>
/* ... stile identico al tuo ... */
</style>