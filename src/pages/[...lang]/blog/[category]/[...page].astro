---
import { getCollection } from 'astro:content';
import MainLayout from '@/components/layout/MainLayout.astro';
import BlogCard from '@/components/blog/BlogCard.astro';
import { useTranslations } from '@/i18n/ui';
import { routes } from '@/i18n/routes';
import { supportedLanguages, defaultLang, type LangCode } from '@/i18n/config';
import type { CollectionEntry } from 'astro:content';

function getPostHref(post: CollectionEntry<'blog'>, lang: LangCode): string {
  const postSlug = post.id.split('/').pop()?.replace(/\.(mdx|md)$/, '') || '';
  const catKey = post.data.category;
  const catSlug = routes[lang][catKey];
  const prefix = lang === defaultLang ? '' : `/${lang}`;
  return `${prefix}/blog/${catSlug}/${postSlug}`.replace(/\/+/g, '/');
}

export async function getStaticPaths({ paginate }: any) {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);
  const CATEGORY_KEYS = ['cat-autopsia', 'cat-sistemi', 'cat-psicologia', 'cat-esecuzione'] as const;

  return supportedLanguages.flatMap(lang => {
    return CATEGORY_KEYS.flatMap(catKey => {
      const postsInCat = allPosts.filter(
        p => p.data.lang === lang && p.data.category === catKey
      );

      // ✅ Genera SEMPRE almeno la prima pagina, anche se vuota
      return paginate(postsInCat.length > 0 ? postsInCat : [null], {
        params: { 
          lang: lang === defaultLang ? undefined : lang,
          category: routes[lang][catKey] 
        },
        pageSize: 12,
        props: { 
          lang, 
          categoryKey: catKey, 
          isEmpty: postsInCat.length === 0 
        }
      });
    });
  });
}

type CategoryKey = 'cat-autopsia' | 'cat-sistemi' | 'cat-psicologia' | 'cat-esecuzione';

interface Props {
  page: any;
  lang: LangCode;
  categoryKey: CategoryKey;
  isEmpty: boolean;
}

const { page, lang, categoryKey, isEmpty } = Astro.props as Props;
const t = useTranslations(lang);
---

<MainLayout lang={lang} title={`${t(categoryKey)} | Blog`}>
  <div class="monolith-container">
    <header class="category-header animate-fade">
      <span class="section-label">{t('nav.categories')}</span>
      <h1 class="monolith-title">{t(categoryKey)}</h1>
    </header>

    {isEmpty ? (
      <div class="empty-state">
        <p>{t('search.placeholder')?.replace('KEYWORDS...', 'NESSUN POST ANCORA.') || 'No posts yet.'}</p>
      </div>
    ) : (
      <section class="blog-grid">
        {page.data.map((post: CollectionEntry<'blog'>) => (
          <BlogCard 
            title={post.data.title}
            description={post.data.description}
            date={post.data.pubDate}
            href={getPostHref(post, lang)}
          />
        ))}
      </section>
    )}

    {!isEmpty && page.lastPage > 1 && (
      <nav class="pagination" aria-label="Category pagination">
        {page.url.prev ? (
          <a href={page.url.prev} class="nav-link">← PREV</a>
        ) : <span class="disabled">←</span>}
        
        <div class="page-counter">
          <span class="current">{page.currentPage}</span>
          <span class="sep">/</span>
          <span class="total">{page.lastPage}</span>
        </div>

        {page.url.next ? (
          <a href={page.url.next} class="nav-link">NEXT →</a>
        ) : <span class="disabled">→</span>}
      </nav>
    )}
  </div>
</MainLayout>

<style>
  .category-header {
    padding: 12vh 0 6vh;
    border-bottom: 1px solid var(--gold-muted);
    margin-bottom: 4rem;
    text-align: center;
  }

  .section-label {
    display: block;
    font-size: 0.9rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--gold-muted);
    margin-bottom: 1rem;
  }

  .monolith-title {
    font-family: var(--font-sans);
    font-weight: 900;
    font-size: clamp(2rem, 6vw, 4rem);
    color: var(--text-main);
    margin: 0;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 0;
    color: var(--text-muted);
    font-style: italic;
    font-size: 1.2rem;
  }

  .blog-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 400px), 1fr));
    gap: 3rem;
    margin-bottom: 5rem;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 3rem;
    padding: 5rem 0;
    font-weight: 900;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--text-main);
  }

  .nav-link {
    color: var(--gold);
    text-decoration: none;
    transition: letter-spacing 0.3s ease;
  }

  .nav-link:hover {
    letter-spacing: 0.4em;
  }

  .disabled {
    opacity: 0.2;
    pointer-events: none;
  }

  .page-counter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.2rem;
  }

  .current { color: var(--gold); }
  .sep { color: var(--gold-muted); font-weight: 300; }
  .total { color: var(--text-muted); font-size: 0.9rem; }

  @media (max-width: 768px) {
    .pagination { gap: 1.5rem; }
    .blog-grid { gap: 2rem; }
  }
</style>