---
// src/pages/[...lang]/blog/[category]/[post_slug].astro
import { getCollection, render } from 'astro:content';
import MainLayout from '@/components/layout/MainLayout.astro';
import PostScene from '@/components/blog/PostScene.astro';
import { useTranslations } from '@/i18n/ui';
import { routes } from '@/i18n/routes';
import { defaultLang, type LangCode } from '@/i18n/config';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);

  return posts.map(post => {
    const lang = post.data.lang as LangCode;
    const catKey = post.data.category;
    const catSlug = routes[lang][catKey];
    const postSlug = post.id.split('/').pop()?.replace(/\.(mdx|md)$/, '') || '';

    return {
      params: { 
        lang: lang === defaultLang ? undefined : lang,
        category: catSlug,
        post_slug: postSlug 
      },
      props: { post, lang },
    };
  });
}

interface Props {
  post: CollectionEntry<'blog'>;
  lang: LangCode;
}

const { post, lang } = Astro.props as Props;
const t = useTranslations(lang);
const { Content } = await render(post);
---

<MainLayout lang={lang}>
  <PostScene 
    title={post.data.title} 
    categoryLabel={t(post.data.category)}
    pubDate={post.data.pubDate}
    lang={lang}
  >
    <Content />
  </PostScene>
</MainLayout>