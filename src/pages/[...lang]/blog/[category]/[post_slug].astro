---
import { getCollection, render } from 'astro:content';
import MainLayout from '@/components/layout/MainLayout.astro';
import PostScene from '@/components/blog/PostScene.astro';
import { routes, type RouteKey } from '@/i18n/routes';
import { defaultLang, type LangCode } from '@/i18n/config';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);

  return posts.map((post) => {
    const lang = post.data.lang as LangCode;
    const categoryKey = post.data.category as RouteKey;
    const categorySlug = routes[lang][categoryKey];
    const postSlug = post.id.split('/').pop()?.replace(/\.(mdx|md)$/, '') || '';

    return {
      params: { 
        lang: lang === defaultLang ? undefined : lang,
        category: categorySlug,
        post_slug: postSlug 
      },
      props: { post, lang },
    };
  });
}

const { post, lang } = Astro.props;
const { Content } = await render(post);
---

<MainLayout lang={lang as LangCode} title={post.data.title} description={post.data.description}>
  <PostScene 
    title={post.data.title} 
    categoryLabel={post.data.category}
    pubDate={post.data.pubDate}
  >
    <Content />
  </PostScene>
</MainLayout>